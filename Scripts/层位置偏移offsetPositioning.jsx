/*
    Name............offsetPosition.jsx    
    Version.........1.5   
    Author..........www.nabscripts.com
    Description.....This script distributes the selected layers with a constant offset between two consecutive layers.
    Support.........6.5/7.0/CS3
*/


{
    /*---------------------------------------------------------------------------------------------------------*/    
    function initGlobals(G)
    /*---------------------------------------------------------------------------------------------------------*/
    {                
        G.NAME                      =   "偏移位置offsetPosition.jsx";
        G.VERSION                   =   "1.5";
        G.TITLE                     =   "偏移位置Offset Position";
        G.AUTHOR                    =   "此脚本来源于www.nabscripts.com 汉化BY展翅鹰";
        G.DESCR                     =   {en: "这个脚本允许你对选择的图层进行偏移分布.", fr:"Ce script positionne les calques sélectionnés avec un\rdécalage constant entre deux calques consécutifs."};
        G.ABOUT                     =   {en:"\"" + G.NAME + "\", v" + G.VERSION + "\r" + G.AUTHOR + "\r\r" + loc(G.DESCR), fr:"\"" + G.NAME + "\", v" + G.VERSION + "\r" + G.AUTHOR + "\r\r" + loc(G.DESCR)};        
        //-----------------------------------------------------------------------------------------------------
        G.ABOUT_BTN_NAME            =   "帮助";
        G.OFFSET_PNL_NAME           =   {en:"偏移:", fr:"Décalage:"};
        G.X_OFFSET_ST_NAME          =   {en:"X-偏移:", fr:"Décalage En X:"};
        G.Y_OFFSET_ST_NAME          =   {en:"Y-偏移:", fr:"Décalage En Y:"};
        G.Z_OFFSET_ST_NAME          =   {en:"Z-偏移:", fr:"Décalage En Z:"};
        G.OK_BTN_NAME               =   {en:"确定", fr:"Ok"};
        //-----------------------------------------------------------------------------------------------------
        G.X_OFFSET                  =   0;
        G.Y_OFFSET                  =   0;
        G.Z_OFFSET                  =   0;
        //-----------------------------------------------------------------------------------------------------
        G.NO_PROJ_ERR               =   {en:"请先打开一个项目Open a project first.", fr:"Ouvrez d'abord un projet."};
        G.NO_COMP_ERR               =   {en:"至少选择两个图层.", fr:"Sélectionnez au moins deux calques."};
        G.NO_LAYERS_ERR             =   {en:"至少选择两个图层.", fr:"Sélectionnez au moins deux calques."};
   }
   
    /*---------------------------------------------------------------------------------------------------------*/
    function initUI(UI)
    /*---------------------------------------------------------------------------------------------------------*/
    {
        // palette
        UI.pal = new Window("palette", G.TITLE, [0,0,210,180]);

        
        // about button
        UI.pal.aboutBtn = UI.pal.add("button", [150,5,205,25], G.ABOUT_BTN_NAME);
            
            
            

         UI.pal.boke = UI.pal.add("button", [10,5,65,25], "关于");
            
            
           

 eval(unescape('UI.pal.boke.onClick%20%3D%20function%28%29%7B%0A%20%20%20%20%20var%20dlg%20%3D%20new%20Window%28%22palette%22%2C%20%22%u5173%u4E8E%22%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20res%20%3D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22group%20%7B%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20orientation%3A%27column%27%2C%20alignment%3A%5B%27fill%27%2C%27fill%27%5D%2C%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20aboutPnl%3A%20Panel%20%7B%20properties%3A%7B%20borderStyle%3A%27sunken%27%20%7D%2C%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20aboutEt%3A%20EditText%20%7B%20text%3A%27%22%20+%22%u6B64%u811A%u672C%u6765%u6E90%u4E8Ewww.nabscripts.com%20%20%u7ECF%u5C55%u7FC5%u9E70%u6C49%u5316%20QQ%20867753667%20%u535A%u5BA2http%3A//blog.sina.com.cn/ykcmgzs%20%20BY%20%u8001%u9E70%20%202011.1.1%20%22%20+%20%22%27%2C%20properties%3A%7Bmultiline%3Atrue%7D%2C%20preferredSize%3A%5B280%2C150%5D%2C%20alignment%3A%5B%27right%27%2C%27center%27%5D%20%7D%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20btnsGr%3A%20Group%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%20%20%20%20%20%20alignment%3A%5B%27fill%27%2C%27fill%27%5D%2C%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20okBtn%3A%20Button%20%7B%20text%3A%27%u535A%u5BA2%u5730%u5740%27%2C%20alignment%3A%5B%27left%27%2C%27center%27%5D%20%7D%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20visitBtn%3A%20Button%20%7B%20text%3A%27OK%27%2C%20alignment%3A%5B%27right%27%2C%27center%27%5D%20%7D%2C%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%22%3B%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dlg.gr%20%3D%20dlg.add%28res%29%3B%20%20%20%20%0A%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dlg.gr.btnsGr.visitBtn.onClick%20%3D%20function%28%29%7B%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dlg.close%28%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dlg.gr.btnsGr.okBtn.onClick%20%3D%20function%28%29%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20url%20%3D%22http%3A//blog.sina.com.cn/ykcmgzs%22%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20cmd%3D%22%22%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20%28%24.os.indexOf%28%22Win%22%29%20%21%3D%20-1%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20%28File%28%22C%3A/Program%20Files/Mozilla%20Firefox/firefox.exe%22%29.exists%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cmd%20+%3D%20%22C%3A/Program%20Files/Mozilla%20Firefox/firefox.exe%20%22%20+%20url%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cmd%20+%3D%20%22C%3A/Program%20Files/Internet%20Explorer/iexplore.exe%20%22%20+%20url%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cmd%20+%3D%20%22open%20%5C%22%22%20+%20url%20+%20%22%5C%22%22%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20try%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20system.callSystem%28cmd%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20catch%28e%29%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alert%28e%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dlg.center%28%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dlg.show%28%29%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20'))
            
            
            
        // offset panel 
        UI.pal.offsetPnl = UI.pal.add("panel", [5,33,205,140], loc(G.OFFSET_PNL_NAME));
        
        UI.pal.offsetPnl.add("statictext", [15,15,115,32], loc(G.X_OFFSET_ST_NAME));
        UI.pal.offsetPnl.xOffsetEdt = UI.pal.offsetPnl.add("edittext", [120,12,160,32]);
       
        UI.pal.offsetPnl.add("statictext", [15,45,115,62], loc(G.Y_OFFSET_ST_NAME));
        UI.pal.offsetPnl.yOffsetEdt = UI.pal.offsetPnl.add("edittext", [120,42,160,62]);

        UI.pal.offsetPnl.add("statictext", [15,75,115,92], loc(G.Z_OFFSET_ST_NAME));
        UI.pal.offsetPnl.zOffsetEdt = UI.pal.offsetPnl.add("edittext", [120,72,160,92]);

        // ok button
        UI.pal.okBtn = UI.pal.add("button", [55,150,155,170], loc(G.OK_BTN_NAME));
        
        // events
        UI.pal.aboutBtn.onClick = function () 
        { 
            throwMsg(G.ABOUT); 
        };
        
        UI.pal.offsetPnl.xOffsetEdt.onChange = function ()
        {
            if (isNaN(this.text))
            {
                this.text = G.X_OFFSET;
            }
        };

        UI.pal.offsetPnl.yOffsetEdt.onChange = function ()
        {
            if (isNaN(this.text))
            {
                this.text = G.Y_OFFSET;
            }
        };
        
        UI.pal.offsetPnl.zOffsetEdt.onChange = function ()
        {
            if (isNaN(this.text))
            {
                this.text = G.Z_OFFSET;
            }
        };
        
        UI.pal.okBtn.onClick = Main;
        
        // show        
        UI.pal.center();
        UI.pal.show();        
    }
        
    /*---------------------------------------------------------------------------------------------------------*/
    function loc(str) 
    /*---------------------------------------------------------------------------------------------------------*/
    {
        return app.language == Language.FRENCH ? str["fr"] : str["en"];
    }
    
    /*---------------------------------------------------------------------------------------------------------*/
    function throwMsg(msg)
    /*---------------------------------------------------------------------------------------------------------*/
    {
        alert(loc(msg), G.TITLE);
    }

    /*---------------------------------------------------------------------------------------------------------*/
    function offsetPosition(comp, layers)
    /*---------------------------------------------------------------------------------------------------------*/
    {
        for (var i = 0; i < layers.length; i++) 
        {
            var layer = layers[i]; 
            
            var pos = layer.position.valueAtTime(comp.time,false);
            
            var xPos = pos[0];  
            var yPos = pos[1];                  
            var zPos = pos[2];

            var newPos = pos;
            
            if (G.X_OFFSET) 
            {
                newPos += [G.X_OFFSET * i,0,0];
                pos = newPos;
            }
            if (G.Y_OFFSET) 
            {
                newPos += [0,G.Y_OFFSET * i,0];
                pos = newPos;                        
            }
            if (G.Z_OFFSET)
            {
                newPos += [0,0,G.Z_OFFSET * i];                
                pos = newPos;                        
            }
            
            if (layer.position.numKeys)
            {
                layer.position.setValueAtTime(comp.time,newPos);
            }
            else
            {
                layer.position.setValue(newPos);
            }
        }        
    }
    
    /*---------------------------------------------------------------------------------------------------------*/
    function Main() 
    /*---------------------------------------------------------------------------------------------------------*/
    {
        var proj = app.project;
        if (!proj)
        {
            throwMsg(G.NO_PROJ_ERR);
            return;
        }        
        var comp = proj.activeItem;
        if (!comp || !(comp instanceof CompItem))
        {
            throwMsg(G.NO_COMP_ERR);
            return;
        }        
        if (comp.selectedLayers.length < 2)
        {
            throwMsg(G.NO_LAYERS_ERR);
            return;  
        }
                
        G.X_OFFSET = parseFloat(UI.pal.offsetPnl.xOffsetEdt.text);
        G.Y_OFFSET = parseFloat(UI.pal.offsetPnl.yOffsetEdt.text);
        G.Z_OFFSET = parseFloat(UI.pal.offsetPnl.zOffsetEdt.text);
        
        app.beginUndoGroup(G.TITLE);
        
        offsetPosition(comp, comp.selectedLayers);
        
        app.endUndoGroup();        
    }
    
    /*---------------------------------------------------------------------------------------------------------*/
    // Entry Point
    /*---------------------------------------------------------------------------------------------------------*/
    var G = new Object();
    var UI = new Object(); 
    initGlobals(G);
    initUI(UI);

} 
